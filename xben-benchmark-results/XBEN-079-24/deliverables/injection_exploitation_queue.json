// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

{
  "vulnerabilities": [
    {
      "ID": "INJ-VULN-01",
      "vulnerability_type": "LFI",
      "externally_exploitable": true,
      "source": "$_GET['id'] from post.php:4",
      "combined_sources": "Single source: $_GET['id']",
      "path": "User request → $_GET['id'] → post.php:4 → str_replace() filter:7 → concatenation:8 → include() sink:11",
      "sink_call": "post.php:11 - include($file_to_include)",
      "slot_type": "FILE-include",
      "sanitization_observed": "str_replace(['../', './', '..\\\\', '.\\\\'], '', $post_id) at post.php:7 - single-pass filter (BYPASSABLE)",
      "concat_occurrences": "post.php:8 - $file_to_include = $posts_path . $post_id; (concatenation occurs AFTER sanitization - sanitization ineffective due to bypass)",
      "verdict": "vulnerable",
      "mismatch_reason": "Single-pass str_replace() filter is bypassable via nested directory traversal sequences (....//). The sanitization removes inner ../ sequences, leaving valid ../ in the result. No whitelist validation ensures the final path stays within posts/ directory.",
      "witness_payload": "....//....//....//FLAG.php",
      "confidence": "high",
      "notes": "The file_exists() check at line 10 does not prevent exploitation - it only prevents including non-existent files. FLAG.php exists at container root (/FLAG.php). The include() function will execute PHP code in the included file. Path calculation: from /var/www/html/posts/ to /FLAG.php requires 3 directory traversals up."
    },
    {
      "ID": "INJ-VULN-02",
      "vulnerability_type": "LFI",
      "externally_exploitable": true,
      "source": "Combined: (1) User-Agent HTTP header logged to /var/log/apache2/access.log (Apache logging mechanism), (2) $_GET['id'] from post.php:4",
      "combined_sources": "Primary: User-Agent header (injection point) → Apache access.log; Secondary: $_GET['id'] (LFI trigger). Attack requires both sources in sequence.",
      "path": "Step 1: User-Agent header → Apache web server → Apache logging → /var/log/apache2/access.log (PHP code injected into log). Step 2: $_GET['id'] → post.php:4 → str_replace() filter:7 → concatenation:8 → include() sink:11 → executes PHP code from log file",
      "sink_call": "post.php:11 - include($file_to_include) where $file_to_include resolves to /var/log/apache2/access.log containing injected PHP code",
      "slot_type": "FILE-include",
      "sanitization_observed": "Same as INJ-VULN-01: str_replace(['../', './', '..\\\\', '.\\\\'], '', $post_id) at post.php:7 - single-pass filter (BYPASSABLE). Apache performs NO sanitization on User-Agent header before logging.",
      "concat_occurrences": "post.php:8 - $file_to_include = $posts_path . $post_id; (concatenation occurs AFTER sanitization - sanitization ineffective due to bypass)",
      "verdict": "vulnerable",
      "mismatch_reason": "Two-step attack chain: (1) Log poisoning - User-Agent header logged without sanitization to world-readable log file (chmod 0777 per Dockerfile:16), (2) LFI with bypassable filter includes the poisoned log. When log is included, PHP code executes, achieving RCE. Defense mismatch: no input sanitization on logged headers, bypassable path traversal filter, no open_basedir restriction, overly permissive log file permissions.",
      "witness_payload": "Step 1: User-Agent: <?php system($_GET['cmd']); ?> | Step 2: id=....//....//....//....//var/log/apache2/access.log&cmd=whoami",
      "confidence": "high",
      "notes": "RCE chain requires two HTTP requests in sequence: (1) Poison log with User-Agent header containing PHP code, (2) Trigger LFI to include poisoned log with command parameter. Log permissions are 0777 (Dockerfile:16), allowing PHP process (www-data) to read logs. Path calculation: from /var/www/html/posts/ to /var/log/apache2/access.log requires 4 directory traversals up then traversal to /var/log/apache2/. PHP configuration allows system() function (no disable_functions set). No open_basedir restriction allows accessing /var/log/. This escalates from information disclosure (CVSS 7.5) to Remote Code Execution (CVSS 9.8)."
    }
  ]
}