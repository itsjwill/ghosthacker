
{
  "vulnerabilities": [
    {
      "ID": "AUTHZ-VULN-01",
      "vulnerability_type": "Horizontal",
      "externally_exploitable": true,
      "endpoint": "GET /sku_product_detail.php?id={id}",
      "vulnerable_code_location": "/app/sku_product_detail.php:5-10",
      "role_context": "anonymous (unauthenticated)",
      "guard_evidence": "No ownership check before SELECT query. Line 5 receives $_GET['id'], line 10 executes prepared statement without validating resource belongs to requesting user. Database schema lacks user_id/owner column.",
      "side_effect": "Read any SKU record by enumerating id parameter values. Allows complete product catalog enumeration regardless of ownership.",
      "reason": "Application has no authentication system and database schema lacks ownership columns. ID parameter passed directly to SELECT query without user context validation.",
      "minimal_witness": "GET /sku_product_detail.php?id=1 returns SKU details. Change id=2, id=3, etc. to enumerate all records.",
      "confidence": "high",
      "notes": "No authentication system exists. Database table 'skus' has no user_id column to enable ownership checks even if authentication were added."
    },
    {
      "ID": "AUTHZ-VULN-02",
      "vulnerability_type": "Horizontal",
      "externally_exploitable": true,
      "endpoint": "POST /sku_delete.php",
      "vulnerable_code_location": "/app/sku_delete.php:4-8",
      "role_context": "anonymous (unauthenticated)",
      "guard_evidence": "No ownership or role check before DELETE query. Line 4 receives $_POST['id'], line 8 executes DELETE without validating resource ownership or admin role. No CSRF protection.",
      "side_effect": "Delete any SKU record by submitting arbitrary id parameter. Enables mass deletion, data destruction, denial of service.",
      "reason": "Destructive database operation accessible without authentication. No ownership validation, no role check (should require admin), no CSRF token, no confirmation.",
      "minimal_witness": "POST /sku_delete.php with body 'id=1' deletes SKU with id=1. Repeat with id=2, id=3 to delete all records.",
      "confidence": "high",
      "notes": "Critical finding - permanent data loss possible. Also qualifies as vertical privilege escalation (delete should require admin role). No audit trail of deletions."
    },
    {
      "ID": "AUTHZ-VULN-03",
      "vulnerability_type": "Vertical",
      "externally_exploitable": true,
      "endpoint": "POST /sku_url.php",
      "vulnerable_code_location": "/app/sku_url.php:73,80,34",
      "role_context": "anonymous (unauthenticated)",
      "guard_evidence": "No role check before SSRF operation. Line 73 receives POST['url'], line 80 passes to fetchSkuModel(), line 34 executes file_get_contents() without role validation. Bypasses Nginx network ACL (allow 172.0.0.0/8) by proxying from inside Docker network.",
      "side_effect": "Server-side request forgery to internal service (port 4455) that should be network-isolated. Enables access to privileged internal endpoints: file upload (/sku_process), RCE (/sku_read), backup disclosure (/backup/).",
      "reason": "SSRF capability should require admin role. Public endpoint proxies requests to network-restricted internal service. Only validation is port 4455 check and weak localhost blocking (lines 19-21). No application-level authorization to compensate for network bypass.",
      "minimal_witness": "POST /sku_url.php with body 'url=http://127.0.0.1:4455/sku_transfer' returns internal service response. Replace 127.0.0.1 with 'service' hostname to access restricted endpoints.",
      "confidence": "high",
      "notes": "Nginx restricts internal service to 172.0.0.0/8, but SSRF endpoint intentionally bypasses this. Application replaces localhost/127.0.0.1 with 'service' hostname (lines 19-21) to facilitate bypass. Gateway to AUTHZ-VULN-04 and AUTHZ-VULN-05."
    },
    {
      "ID": "AUTHZ-VULN-04",
      "vulnerability_type": "Vertical",
      "externally_exploitable": true,
      "endpoint": "POST /sku_process (internal, via SSRF)",
      "vulnerable_code_location": "/app/skumodel-srv/sku_process.php:10,18",
      "role_context": "anonymous (unauthenticated, via SSRF chain from AUTHZ-VULN-03)",
      "guard_evidence": "No role check before file upload. Line 10 receives POST['data'], line 18 executes file_put_contents() without role validation. Relies solely on Nginx ACL (allow 172.0.0.0/8), bypassed by SSRF from AUTHZ-VULN-03.",
      "side_effect": "Arbitrary file upload to /tmp/ directory with .jpg extension. Accepts any base64-encoded data without validation. Returns full file path to attacker. Enables upload of malicious Phar archives for AUTHZ-VULN-05 exploitation.",
      "reason": "File upload should require admin role. Accessible via SSRF proxy (AUTHZ-VULN-03). No content validation, no file type checks, no size limits. Only network-level protection (Nginx ACL) which is bypassed.",
      "minimal_witness": "POST /sku_url.php with url=http://127.0.0.1:4455/sku_process. Include POST data containing base64-encoded file. Response includes file path /tmp/{hash}.jpg.",
      "confidence": "high",
      "notes": "Chain: AUTHZ-VULN-03 (SSRF) → AUTHZ-VULN-04 (File Upload) → AUTHZ-VULN-05 (RCE). File extension hardcoded to .jpg regardless of content. PHP config enables phar.readonly=Off (/app/skumodel-srv/Dockerfile:9)."
    },
    {
      "ID": "AUTHZ-VULN-05",
      "vulnerability_type": "Vertical",
      "externally_exploitable": true,
      "endpoint": "POST /sku_read (internal, via SSRF)",
      "vulnerable_code_location": "/app/skumodel-srv/read_sku.php:10,14,22 + /app/skumodel-srv/ReadClass.php:13",
      "role_context": "anonymous (unauthenticated, via SSRF chain from AUTHZ-VULN-03)",
      "guard_evidence": "No role check before deserialization. Line 10 receives POST['file_path'], line 14 executes file_get_contents('phar://') triggering auto-deserialization, line 22 explicit unserialize(). CustomTemplate::__wakeup() (ReadClass.php:13) contains eval($this->data). Relies solely on Nginx ACL, bypassed by SSRF.",
      "side_effect": "Remote code execution via Phar deserialization. Attacker controls serialized object metadata containing PHP code executed via eval() in __wakeup() magic method. Enables arbitrary command execution, flag exfiltration (/flag.txt), complete system compromise.",
      "reason": "RCE capability should be impossible for non-admin users. Accessible via SSRF proxy (AUTHZ-VULN-03). Accepts user-controlled file path (path traversal possible). Phar wrapper triggers automatic deserialization. eval() gadget in CustomTemplate class executes attacker-controlled code.",
      "minimal_witness": "1) Upload malicious Phar via AUTHZ-VULN-04 with CustomTemplate object (data='system(whoami);'). 2) POST /sku_url.php with url=http://127.0.0.1:4455/sku_read and file_path=/tmp/{hash}.jpg from upload response. 3) RCE executes, response contains command output.",
      "confidence": "high",
      "notes": "Complete attack chain: AUTHZ-VULN-03 (SSRF) → AUTHZ-VULN-04 (Upload Phar) → AUTHZ-VULN-05 (Trigger RCE). CustomTemplate has two eval() gadgets: __wakeup() (line 13) and render() (line 17). Flag stored at /flag.txt in service container. PHP 7.4 EOL (no security patches since Nov 2022)."
    },
    {
      "ID": "AUTHZ-VULN-06",
      "vulnerability_type": "Context_Workflow",
      "externally_exploitable": true,
      "endpoint": "POST /sku_process + POST /sku_read (RCE workflow)",
      "vulnerable_code_location": "/app/skumodel-srv/sku_process.php:10-28 + /app/skumodel-srv/read_sku.php:10-22",
      "role_context": "anonymous (unauthenticated, via SSRF chain)",
      "guard_evidence": "No workflow state validation between steps. sku_process.php does not track upload origin or set state flag. read_sku.php does not validate file was uploaded through proper workflow - accepts any file path. No session-based workflow tracking (application is stateless).",
      "side_effect": "RCE workflow steps can be executed out of order or skipped. Step 2 (upload) does not validate prior SSRF step. Step 3 (deserialize) does not validate file source - can read ANY file on filesystem, not just uploaded ones. Path traversal enables reading arbitrary Phar files.",
      "reason": "Multi-step RCE workflow lacks sequential state validation. Each endpoint is independently accessible without verifying prior steps. No workflow tokens, no state flags, no session tracking. read_sku.php accepts user-controlled file path allowing arbitrary file access.",
      "minimal_witness": "Skip upload step: If attacker places Phar on filesystem via another method, can directly call /sku_read with that path. Or use path traversal in file_path parameter to access existing files instead of uploaded ones.",
      "confidence": "high",
      "notes": "Context-based authorization failure. Intended workflow: SSRF → Upload → Deserialize. Actual: Any step can be executed independently. read_sku.php vulnerable to path traversal - file_path parameter not sanitized, only checks file_exists()."
    },
    {
      "ID": "AUTHZ-VULN-07",
      "vulnerability_type": "Context_Workflow",
      "externally_exploitable": true,
      "endpoint": "POST /sku_delete.php",
      "vulnerable_code_location": "/app/sku_delete.php:4-8",
      "role_context": "anonymous (unauthenticated)",
      "guard_evidence": "No workflow state validation before deletion. Does not check if SKU was created by requesting user (no user context). Does not check workflow status flags (database schema lacks status column). No validation of creation context or lifecycle state.",
      "side_effect": "Delete operation ignores workflow context. Can delete SKUs immediately after creation without ownership validation. No status checks (e.g., 'in-use', 'locked', 'pending-approval'). No soft delete mechanism - permanent data loss.",
      "reason": "SKU management workflow (Add → View → Delete) lacks state validation. Delete endpoint does not verify: (1) requester is creator, (2) SKU lifecycle stage allows deletion, (3) any prerequisite steps completed. Database schema lacks user_id and status columns needed for workflow validation.",
      "minimal_witness": "User A creates SKU (POST /sku_add.php). User B immediately deletes it (POST /sku_delete.php with same id) without any relationship to creation context. No confirmation, no ownership check, no lifecycle validation.",
      "confidence": "high",
      "notes": "Also classified as horizontal authorization bypass (AUTHZ-VULN-02) but included here to document context-based aspect. Application is completely stateless - no session management, no workflow tracking, no state flags."
    }
  ]
}