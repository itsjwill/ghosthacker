#!/usr/bin/env bash

# ============================================================================
# GHOST HACKER - Adversarial AI Pentester
# Enhanced Shannon with CHAOS vs ORDER dual-agent exploitation
# ============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
COMPOSE_FILE="$SCRIPT_DIR/docker-compose.yml"
ENHANCED_COMPOSE_FILE="$SCRIPT_DIR/docker-compose.enhanced.yml"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ASCII Art
print_banner() {
    echo -e "${MAGENTA}"
    cat << 'EOF'
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
  â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘
  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
   â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•   â•šâ•â•
  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
  â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•
EOF
    echo -e "${NC}"
    echo -e "${CYAN}  Adversarial AI Pentester - CHAOS vs ORDER${NC}"
    echo -e "${YELLOW}  ðŸ”¥ Dual-agent exploitation with collective memory${NC}"
    echo ""
}

# Help
show_help() {
    print_banner
    echo "Usage: ./ghosthacker <command> [options]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}start${NC}     Start a penetration test"
    echo -e "  ${GREEN}logs${NC}      View worker logs"
    echo -e "  ${GREEN}query${NC}     Query workflow progress"
    echo -e "  ${GREEN}stop${NC}      Stop all containers"
    echo -e "  ${GREEN}memory${NC}    View collective memory stats"
    echo ""
    echo "Options for 'start':"
    echo "  URL=<url>           Target URL (required)"
    echo "  REPO=<path>         Path to source code (required)"
    echo "  CONFIG=<file>       YAML config file"
    echo "  OUTPUT=<path>       Output directory"
    echo "  ADVERSARIAL=true    Enable CHAOS vs ORDER mode (default: true)"
    echo "  CLASSIC=true        Use classic single-agent mode"
    echo ""
    echo "Examples:"
    echo -e "  ${CYAN}./ghosthacker start URL=https://app.example.com REPO=/path/to/code${NC}"
    echo -e "  ${CYAN}./ghosthacker start URL=https://app.example.com REPO=/code ADVERSARIAL=true${NC}"
    echo -e "  ${CYAN}./ghosthacker logs${NC}"
    echo -e "  ${CYAN}./ghosthacker memory${NC}"
    echo ""
}

# Parse arguments
parse_args() {
    for arg in "$@"; do
        case $arg in
            URL=*)
                TARGET_URL="${arg#*=}"
                ;;
            REPO=*)
                REPO_PATH="${arg#*=}"
                ;;
            CONFIG=*)
                CONFIG_PATH="${arg#*=}"
                ;;
            OUTPUT=*)
                OUTPUT_PATH="${arg#*=}"
                ;;
            ADVERSARIAL=*)
                ADVERSARIAL="${arg#*=}"
                ;;
            CLASSIC=*)
                CLASSIC="${arg#*=}"
                ;;
            ID=*)
                WORKFLOW_ID="${arg#*=}"
                ;;
            CLEAN=*)
                CLEAN="${arg#*=}"
                ;;
        esac
    done
}

# Start command
cmd_start() {
    parse_args "$@"

    if [[ -z "$TARGET_URL" || -z "$REPO_PATH" ]]; then
        echo -e "${RED}Error: URL and REPO are required${NC}"
        echo ""
        show_help
        exit 1
    fi

    print_banner

    # Determine mode
    if [[ "$CLASSIC" == "true" ]]; then
        echo -e "${YELLOW}Mode: Classic (single-agent)${NC}"
        TASK_QUEUE="shannon-pentest"
        WORKFLOW="pentestPipelineWorkflow"
    else
        echo -e "${MAGENTA}Mode: ADVERSARIAL (CHAOS vs ORDER)${NC}"
        TASK_QUEUE="shannon-enhanced"
        WORKFLOW="enhancedPentestWorkflow"
    fi

    echo -e "${CYAN}Target:${NC} $TARGET_URL"
    echo -e "${CYAN}Repository:${NC} $REPO_PATH"
    echo ""

    # Start containers
    echo -e "${BLUE}Starting Ghost Hacker containers...${NC}"
    docker compose -f "$COMPOSE_FILE" up -d

    # Wait for Temporal
    echo -e "${BLUE}Waiting for Temporal server...${NC}"
    sleep 5

    # Generate workflow ID
    WORKFLOW_ID="ghosthacker-$(date +%s)"

    # Build workflow input
    WORKFLOW_INPUT=$(cat <<EOF
{
    "webUrl": "$TARGET_URL",
    "repoPath": "$REPO_PATH",
    "enableAdversarial": true
EOF
)

    if [[ -n "$CONFIG_PATH" ]]; then
        WORKFLOW_INPUT="$WORKFLOW_INPUT, \"configPath\": \"$CONFIG_PATH\""
    fi

    if [[ -n "$OUTPUT_PATH" ]]; then
        WORKFLOW_INPUT="$WORKFLOW_INPUT, \"outputPath\": \"$OUTPUT_PATH\""
    fi

    WORKFLOW_INPUT="$WORKFLOW_INPUT }"

    # Start workflow
    echo -e "${GREEN}Starting workflow: $WORKFLOW_ID${NC}"
    echo ""

    docker compose -f "$COMPOSE_FILE" exec -T worker node dist/temporal/client.js \
        --workflow "$WORKFLOW" \
        --taskQueue "$TASK_QUEUE" \
        --workflowId "$WORKFLOW_ID" \
        --input "$WORKFLOW_INPUT"

    echo ""
    echo -e "${GREEN}âœ… Workflow started: $WORKFLOW_ID${NC}"
    echo ""
    echo -e "Monitor progress:"
    echo -e "  ${CYAN}./ghosthacker logs${NC}"
    echo -e "  ${CYAN}./ghosthacker query ID=$WORKFLOW_ID${NC}"
    echo -e "  ${CYAN}open http://localhost:8233${NC} (Temporal UI)"
}

# Logs command
cmd_logs() {
    print_banner
    echo -e "${BLUE}Streaming worker logs...${NC}"
    echo ""
    docker compose -f "$COMPOSE_FILE" logs -f worker
}

# Query command
cmd_query() {
    parse_args "$@"

    print_banner

    if [[ -z "$WORKFLOW_ID" ]]; then
        echo -e "${YELLOW}Listing recent workflows...${NC}"
        docker compose -f "$COMPOSE_FILE" exec -T worker node dist/temporal/query.js --list
    else
        echo -e "${CYAN}Querying workflow: $WORKFLOW_ID${NC}"
        docker compose -f "$COMPOSE_FILE" exec -T worker node dist/temporal/query.js \
            --workflowId "$WORKFLOW_ID"
    fi
}

# Memory command
cmd_memory() {
    print_banner
    echo -e "${MAGENTA}Collective Memory Statistics${NC}"
    echo ""

    # Find memory files
    MEMORY_FILES=$(find . -name "collective-memory.json" 2>/dev/null | head -5)

    if [[ -z "$MEMORY_FILES" ]]; then
        echo -e "${YELLOW}No collective memory found yet.${NC}"
        echo "Memory is built as you run scans."
    else
        for file in $MEMORY_FILES; do
            echo -e "${CYAN}Memory file: $file${NC}"

            if command -v jq &> /dev/null; then
                echo -e "  Attempts recorded: $(jq '.attempts | length' "$file")"
                echo -e "  Techniques tracked: $(jq '.scores | keys | length' "$file")"

                echo -e "\n  ${GREEN}Top techniques:${NC}"
                jq -r '.scores | to_entries | sort_by(-.value.successRate) | .[0:5] | .[] | "    \(.key): \(.value.successRate * 100 | floor)% success (\(.value.sampleSize) samples)"' "$file"
            else
                echo "  (Install jq for detailed stats)"
                wc -c "$file"
            fi
            echo ""
        done
    fi
}

# Stop command
cmd_stop() {
    parse_args "$@"

    print_banner
    echo -e "${YELLOW}Stopping Ghost Hacker...${NC}"

    if [[ "$CLEAN" == "true" ]]; then
        echo -e "${RED}Cleaning all data...${NC}"
        docker compose -f "$COMPOSE_FILE" down -v --remove-orphans
    else
        docker compose -f "$COMPOSE_FILE" down
    fi

    echo -e "${GREEN}âœ… Stopped${NC}"
}

# Main
case "${1:-}" in
    start)
        shift
        cmd_start "$@"
        ;;
    logs)
        cmd_logs
        ;;
    query)
        shift
        cmd_query "$@"
        ;;
    memory)
        cmd_memory
        ;;
    stop)
        shift
        cmd_stop "$@"
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        show_help
        exit 1
        ;;
esac
